<!DOCTYPE html>
<html lang=ja>
<head>
    <meta charset="UTF-8">
    <title>PomoServer.exe</title>
</head>

<body>
    <h1>ようこそ！{%%hogehogefugafuga}回目にアクセスした君！Hello World!</h1>

    <p id="counter"></p>

    <p>ここに好きなファイルをアップロードしてね</p>
    <!--<input type="file" accept="image/*" id="objectInput"/>-->
    <!--<form name="uploadForm" action="/upload" method="POST" enctype="multipart/form-data">-->
        <div>
            <input id="uploadInput" type="file" accept="image/*" />
            <label for="fileCount">選択されたファイル:</label>
            <output id="fileCount">0</output>;
            <label for="fileSize">合計サイズ:</label>
            <output id="fileSize">0</output>
        </div>
        <div><input id="submitButton" type="submit" value="Send file" /></div>
    <!--</form>-->
    <script>
        (async () => {
            while (false) {
                const response = await fetch("count/", { method: "GET" });
                const text = await response.text();
                document.getElementById("counter").textContent = `今世界から${text}回アクセスされてますぞい！`;
            }
        })();

        const input = document.getElementById("uploadInput");
        const fileCount = document.getElementById("fileCount");
        const fileSize = document.getElementById("fileSize");

        input.addEventListener("change", () => {
            const files = input.files;
            fileCount.value = files.length;
            let sumSize = 0;
            for (const file of files) {
                sumSize += file.size;
            }
            fileSize.value = `${sumSize} byte`;  // 合計サイズの計算したやつ！
        });

        const submitButton = document.getElementById("submitButton");
        submitButton.addEventListener("click", async () => {
            event.preventDefault();

            const file = input.files[0];
            const reader = new FileReader();
            reader.addEventListener("load", async (e) => {
                const buffer = e.target.result;

                const response = await fetch("/objectcreate", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/octet-stream",
                    },
                    body: buffer,
                });

                if (response.ok) {
                    alert("送信完了");
                }
            });
            reader.readAsArrayBuffer(file);

            //const files = input.files;
            //if (!files.length) {
            //    alert("ファイルが設定されてないよ！");
            //    return;
            //}

            //const formData = new FormData();
            //for (const file of files) {
            //    formData.append("files[]", file);
            //}

            //try {
            //    const response = await fetch("/objectcreate", {
            //        method: "POST",
            //        body: formData,
            //    });
            //} catch (e) {
            //    console.error(e);
            //}
        });

    </script>
</body>

</html>
